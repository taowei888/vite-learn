# Vite 依赖预构建机制

## 概述

依赖预构建是 Vite 的核心特性之一，它通过智能的模块转换和路径重写，解决了 ES Module 在浏览器环境中的兼容性和性能问题。

## 工作原理

### 1. 路径识别与重写

当 Vite 检测到裸导入（bare import）时，会自动进行路径转换：

```javascript
// 开发者编写的代码
import _ from "lodash"

// Vite 自动转换为
import __vite__cjsImport0_lodash from "/node_modules/.vite/deps/lodash.js?v=4d2cde77"
```

### 2. 依赖查找机制

Vite 采用 Node.js 的模块解析算法，从当前目录开始逐级向上查找：

```
项目根目录/
├── src/
│   ├── components/
│   │   └── Button.js  <- 从这里开始查找
│   └── node_modules/  <- 查找路径1
├── node_modules/      <- 查找路径2 ✅ 找到 lodash
└── package.json
```

## 核心构建流程

### Phase 1: 依赖发现
```javascript
// Vite 扫描入口文件，发现依赖
import axios from 'axios'      // CommonJS 包
import _ from 'lodash'         // ES Module 包
import vue from 'vue'         // 混合格式包
```

### Phase 2: 格式转换
使用 **esbuild** 进行高速转换：

```javascript
// 原始 CommonJS 格式 (axios)
module.exports = function axios(config) {
  // ...
}

// 转换后的 ES Module 格式
export default function axios(config) {
  // ...
}
```

### Phase 3: 模块集成
将分散的模块文件合并，减少网络请求：

```javascript
// 原始结构（多个文件）
lodash/
├── index.js
├── chunk.js
├── compact.js
└── ... (数百个文件)

// 预构建后（单个文件）
node_modules/.vite/deps/
└── lodash.js  // 包含所有功能的单一文件
```

## 解决的核心问题

### 🔄 1. 模块格式统一

不同的第三方包可能使用不同的模块格式：

| 包名 | 原始格式 | 转换后 |
|------|----------|--------|
| axios | CommonJS | ES Module |
| lodash | ES Module | ES Module (优化) |
| moment | UMD | ES Module |

### 🛣️ 2. 路径处理优化

```javascript
// 开发环境：直接使用预构建路径
import _ from '/node_modules/.vite/deps/lodash.js'

// 生产环境：交给 Rollup 处理
// → 最终打包到 dist/assets/index-xxx.js
```

### ⚡ 3. 网络性能优化

**问题场景**：
```javascript
import { debounce } from 'lodash-es'
// 如果没有预构建，可能触发：
// → lodash-es/debounce.js
// → lodash-es/_baseDelay.js
// → lodash-es/_toNumber.js
// → ... (数十个网络请求)
```

**解决方案**：
```javascript
// 预构建后，只需一个请求
import { debounce } from '/node_modules/.vite/deps/lodash-es.js'
```

## 开发 vs 生产环境

### 开发环境 (vite dev)
- ✅ 使用预构建的依赖
- ✅ 支持热更新 (HMR)
- ✅ 快速冷启动

### 生产环境 (vite build)
- 🔄 交给 **Rollup** 处理
- 📦 Tree-shaking 优化
- 🗜️ 代码压缩和分块

## 配置与优化

### vite.config.js 配置示例

```javascript
export default {
  optimizeDeps: {
    // 强制包含某些依赖
    include: ['lodash-es', 'dayjs'],
    
    // 排除某些依赖（不推荐，会影响性能）
    exclude: ['@vueuse/core'],
    
    // 自定义 esbuild 选项
    esbuildOptions: {
      target: 'es2020'
    }
  }
}
```

### ⚠️ 注意事项

```javascript
export default {
  optimizeDeps: {
    // ❌ 排除 lodash-es 会导致大量网络请求
    exclude: ['lodash-es'], 
    // 原因: lodash-es 包含数百个独立模块文件
    // 结果: 浏览器需要发起数百个网络请求，性能极差
  }
}
```

## 缓存机制

Vite 会自动缓存预构建结果：

```
node_modules/.vite/
├── deps/              # 预构建的依赖
│   ├── lodash.js
│   └── axios.js
├── _metadata.json     # 缓存元数据
└── package.json       # 依赖版本信息
```

当以下情况发生时，会触发重新构建：
- `package.json` 中的依赖版本变化
- `vite.config.js` 中的 `optimizeDeps` 配置变化
- 手动删除 `.vite` 目录
