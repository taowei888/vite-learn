# Vite 生产环境静态资源管理

## 概述

当我们将工程进行打包后，Vite 会对静态资源进行优化处理，包括文件名哈希化、资源分类存放、内联优化等。这些处理确保了生产环境的性能和缓存策略的有效性。

## 构建配置

### Vite 构建相关配置

```javascript
// vite.base.config.js
export default defineConfig({
    build: {
        // Rollup 构建选项
        rollupOptions: {
            output: {
                // 静态资源文件命名规则
                assetFileNames: '[hash].[name].[ext]',
            },
        },
        
        // 静态资源内联阈值：4KB
        assetsInlineLimit: 4096,
        
        // 构建输出目录
        outDir: 'testDist',
        
        // 静态资源子目录
        assetsDir: "static"
    },
})
```

## 构建产物分析

### 构建命令执行

```bash
npm run build
```

**构建输出：**
```
vite v7.0.6 building for production...
transforming...
✓ 6 modules transformed.
rendering chunks...
computing gzip size...
testDist/index.html                0.28 kB │ gzip: 0.22 kB
testDist/static/index-ZgB8lTmc.js  2.81 kB │ gzip: 1.24 kB
✓ built in 33ms
```

### 目录结构

```
testDist/                    # 构建输出目录
├── index.html              # HTML 入口文件
└── static/                 # 静态资源目录
    └── index-ZgB8lTmc.js   # 哈希化的 JS 文件
```

### 文件内容分析

**testDist/index.html：**
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="module" crossorigin src="/static/index-ZgB8lTmc.js"></script>
</head>
<body>
</body>
</html>
```

**关键变化：**
- 原始文件：`main.js`
- 构建后：`/static/index-ZgB8lTmc.js`
- 添加了哈希值：`ZgB8lTmc`

## 静态资源哈希化的意义

### 浏览器缓存机制

**问题场景：**
```
开发时：main.js
构建后：index-ZgB8lTmc.js
```

**缓存逻辑：**
1. 浏览器首次访问时下载 `index-ZgB8lTmc.js`
2. 后续访问相同 URL 时直接使用缓存
3. 文件内容改变时，哈希值改变，文件名改变
4. 浏览器识别为新文件，重新下载

### 为什么需要哈希

#### 传统问题

```javascript
// 没有哈希的情况
<script src="/static/main.js"></script>

// 问题：
// 1. 代码更新后，用户可能仍然使用缓存的旧版本
// 2. 需要手动清除缓存或强制刷新
// 3. 无法精确控制缓存策略
```

#### 哈希解决方案

```javascript
// 有哈希的情况
<script src="/static/index-ZgB8lTmc.js"></script>

// 优势：
// 1. 内容改变 → 哈希改变 → 文件名改变 → 浏览器重新下载
// 2. 内容不变 → 哈希不变 → 文件名不变 → 浏览器使用缓存
// 3. 实现精确的缓存控制
```

## 哈希算法原理

### 什么是哈希

**哈希算法**：将一串字符串经过运算得到一个新的乱码字符串

**特点：**
- 相同输入 → 相同输出
- 不同输入 → 不同输出（概率极高）
- 不可逆（无法从哈希值推导原始内容）
- 固定长度输出

**注意：** 哈希不是全世界独一无二的，UUID 才是真正独一无二的。

### 哈希在缓存中的应用

```javascript
// 文件内容 → 哈希算法 → 哈希值 → 文件名

// 示例：
// 内容: "console.log('hello')" → 哈希: "ZgB8lTmc" → 文件名: "index-ZgB8lTmc.js"
// 内容: "console.log('world')" → 哈希: "AbC9dEfG" → 文件名: "index-AbC9dEfG.js"
```

## 静态资源处理策略

### 1. 文件名哈希化

**配置：**
```javascript
rollupOptions: {
    output: {
        assetFileNames: '[hash].[name].[ext]',
    },
}
```

**效果：**
- `image.png` → `a1b2c3d4.image.png`
- `style.css` → `e5f6g7h8.style.css`

### 2. 资源内联优化

**配置：**
```javascript
assetsInlineLimit: 4096, // 4KB
```

**处理逻辑：**
- 文件 < 4KB → 转换为 base64 内联
- 文件 ≥ 4KB → 保持文件引用

**base64 内联示例：**
```css
/* 原始 */
background-image: url('./small-icon.png');

/* 内联后 */
background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...');
```

**优势与劣势：**

| 内联（< 4KB） | 文件引用（≥ 4KB） |
|---------------|-------------------|
| ✅ 减少 HTTP 请求 | ✅ 利用浏览器缓存 |
| ✅ 首屏加载更快 | ✅ 代码体积更小 |
| ❌ 增加代码体积 | ❌ 增加 HTTP 请求 |
| ❌ 无法缓存资源 | ❌ 可能影响首屏速度 |

### 3. 目录结构优化

**配置：**
```javascript
outDir: 'testDist',      // 输出目录
assetsDir: "static"      // 静态资源子目录
```

**结构优势：**
```
testDist/
├── index.html           # 页面入口
└── static/              # 静态资源集中管理
    ├── *.js            # JavaScript 文件
    ├── *.css           # 样式文件
    └── *.png           # 图片资源
```

**好处：**
- 便于 CDN 部署
- 支持静态资源独立域名
- 方便设置不同的缓存策略

## 缓存策略最佳实践

### 1. 文件级缓存控制

```javascript
// 强缓存设置
// index.html: 不缓存或短期缓存
// /static/*: 长期缓存（1年）

// Nginx 配置示例
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location / {
    expires -1;
    add_header Cache-Control "no-cache";
}
```

### 2. 版本发布策略

```bash
# 发布流程
1. 修改代码
2. 执行构建：npm run build
3. 哈希值自动更新
4. 部署新文件
5. 用户自动获取最新版本
```

### 3. 回退机制

```javascript
// 支持多版本共存
/static/index-ZgB8lTmc.js  // 新版本
/static/index-AbC9dEfG.js  // 旧版本（仍可访问）
```

## 总结

Vite 的静态资源管理通过以下机制确保生产环境的最佳性能：

1. **哈希化文件名**：实现精确的缓存控制
2. **资源内联**：小文件内联减少请求，大文件独立缓存
3. **目录分类**：静态资源集中管理，便于部署
4. **自动优化**：构建时自动应用最佳实践

这些特性让我们能够：
- ✅ 充分利用浏览器缓存
- ✅ 确保用户始终获取最新版本
- ✅ 优化加载性能
- ✅ 简化部署流程

通过合理配置这些选项，可以在缓存效率和加载性能之间找到最佳平衡点。