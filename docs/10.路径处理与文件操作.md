# 路径处理与文件操作

在 Node.js 环境中进行文件操作时，正确处理路径是非常重要的。本文档介绍了相对路径、绝对路径的概念以及在不同环境下的处理方式。

## 核心概念

### 1. process.cwd()

`process.cwd()` 获取 Node.js 当前执行目录（Current Working Directory）。

**特点：**
- 返回启动 Node.js 进程时的工作目录
- 会根据执行命令的位置变化而变化

**示例：**
```javascript
console.log(process.cwd())
```

**执行效果：**
```bash
# 在项目根目录下执行
$ node test-path/main.js
# 输出：/Users/taowei/Pro/Code/vite-learn

# 在 test-path 目录下执行  
$ cd test-path && node main.js
# 输出：/Users/taowei/Pro/Code/vite-learn/test-path
```

### 2. __dirname

`__dirname` 是 CommonJS 规范中的注入变量，始终返回当前文件所在的目录。

**特点：**
- 不受执行位置影响
- 总是指向文件本身所在的目录
- 只在 CommonJS 模块中可用

**示例：**
```javascript
console.log(__dirname)
// 无论在哪里执行，都输出：/Users/taowei/Pro/Code/vite-learn/test-path
```

## 文件路径处理最佳实践

### 问题场景

Node.js 端读取或操作文件时，如果使用相对路径，会使用 `process.cwd()` 进行拼接，这可能导致路径错误。

### 解决方案

#### 1. 使用 __dirname + 相对路径

```javascript
const fs = require('fs')

// ❌ 不推荐：直接字符串拼接
// const result = fs.readFileSync(__dirname + '/variables.css')
// 问题：Mac 和 Windows 系统路径分隔符不同

// ✅ 推荐：使用 path.resolve()
const path = require('path')
const result = fs.readFileSync(path.resolve(__dirname, './variables.css'))
```

#### 2. 跨平台兼容性

使用 `path` 模块确保跨平台兼容：

```javascript
const path = require('path')

// 自动处理不同操作系统的路径分隔符
// Windows: \
// Mac/Linux: /
const filePath = path.resolve(__dirname, './variables.css')
```

## 项目中的实际应用

### 文件结构
```
test-path/
├── main.js           # 主要演示文件
├── index.js          # 空文件
└── variables.css     # CSS 变量文件
```

### main.js 完整示例

```javascript
// node端读取或者操作文件，如果用的是相对路径，会使用process.cwd()去拼接
// process.cwd()获取node当前执行目录
// 如
// 在此项目根目录下 node test-path/main.js 拿到项目根目录绝对路径
// 在此项目test-path目录下 node main.js 拿到项目test-path文件夹绝对路径
console.log(process.cwd())

// commonjs规范
// 注入变量 __dirname 始终返回当前文件所在的目录
console.log(__dirname)

const path = require('path')
const fs = require('fs')

// 希望基于main.js进行绝对路径的生成
// const result = fs.readFileSync(__dirname + '/variables.css')
// 理论上上面写法已经能满足要求，但是会有兼容性问题，比如Mac系统和windows系统斜杠不同，所以需要path模块处理
const result = fs.readFileSync(path.resolve(__dirname, './variables.css'))

console.log('result', result.toString())
```

### variables.css 内容

```css
:root {
    --globalColor: lightblue
}
```

## 在 Vite 项目中的应用

### 配置文件路径处理

在 Vite 配置文件中，也会涉及路径处理：

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import path from 'path'

export default defineConfig({
    resolve: {
        alias: {
            '@': path.resolve(__dirname, 'src'),
            '@components': path.resolve(__dirname, 'src/components')
        }
    }
})
```

### CSS 文件引用

在 CSS 预处理器中处理相对路径：

```javascript
// vite.base.config.js
css: {
    preprocessorOptions: {
        less: {
            // 全局变量文件路径处理
            additionalData: `@import "${path.resolve(__dirname, 'src/styles/variables.less')}";`
        }
    }
}
```

## 路径处理工具函数

### 常用 path 模块方法

```javascript
const path = require('path')

// 路径解析
path.resolve('/users', 'john', 'documents', '..', 'downloads')
// 结果：/users/john/downloads

// 路径拼接
path.join('/users', 'john', 'documents')
// 结果：/users/john/documents

// 获取文件名
path.basename('/users/john/documents/file.txt')
// 结果：file.txt

// 获取目录名
path.dirname('/users/john/documents/file.txt')
// 结果：/users/john/documents

// 获取文件扩展名
path.extname('/users/john/documents/file.txt')
// 结果：.txt
```

## 最佳实践总结

1. **始终使用 `path` 模块**：确保跨平台兼容性
2. **优先使用 `__dirname`**：获得可预测的路径行为
3. **避免硬编码路径分隔符**：使用 `path.join()` 或 `path.resolve()`
4. **在配置文件中处理别名**：简化项目内部引用
5. **文档化路径约定**：团队开发中明确路径处理规范

## 注意事项

- 在 ES Module 中，`__dirname` 不可用，需要使用 `import.meta.url` 替代
- 相对路径的基准是 `process.cwd()`，不是文件所在目录
- 在不同环境（开发/生产）中，路径处理可能有差异，需要充分测试