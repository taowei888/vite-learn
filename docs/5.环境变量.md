# Vite 环境变量配置

> 环境变量：会根据当前的代码环境产生值的变化的变量就叫做环境变量

## 常见代码环境

1. **开发环境** (development)
2. **测试环境** (test) 
3. **预发布环境** (staging)
4. **灰度环境** (gray)
5. **生产环境** (production)

## 实际应用场景

### API Key 管理
以百度地图 SDK、小程序 SDK 为例，不同环境需要不同的 APP_KEY：

```bash
# 开发环境
ENV_APP_KEY = dev

# 测试环境  
ENV_APP_KEY = test

# 生产环境
ENV_APP_KEY = pro
```

### API 接口地址
前端在不同环境中请求的后端 API 地址通常不同：

```bash
# 开发环境
ENV_BASE_URL = http://dev.api/

# 测试环境
ENV_BASE_URL = http://test.api/

# 生产环境
ENV_BASE_URL = http://api/
```

## Vite 环境变量处理机制

### 核心原理

Vite 内置了 `dotenv` 第三方库，会自动读取 `.env` 文件并解析其中的环境变量。为了避免与其他配置产生冲突，Vite 不会直接将环境变量注入到 `process` 对象下。

### 相关配置项

在 `vite.config.js` 中涉及的配置：

- **root**: 项目根目录
- **envDir**: 配置环境变量文件地址，默认读取 `.env`
- **envPrefix**: 环境变量前缀，默认为 `VITE_`

### loadEnv 手动加载

Vite 提供 `loadEnv` 方法来手动确认 env 文件：

```js
import { loadEnv } from 'vite'

export default defineConfig(({ command, mode }) => {
  // process.cwd() 返回当前 node 进程的工作目录
  const env = loadEnv(mode, process.cwd(), '')
  console.log('env=====', env)
  
  return {
    // 配置...
  }
})
```

## 环境变量文件

### 文件命名规范

- **`.env`**: 所有环境都需要用到的环境变量
- **`.env.development`**: 开发环境专用环境变量 (Vite 默认开发环境名为 development)
- **`.env.production`**: 生产环境专用环境变量 (Vite 默认生产环境名为 production) 
- **`.env.test`**: 测试环境专用环境变量

### 项目中的实际文件

```bash
test-vite/
├── .env.development    # ENV_APP_KEY = dev, ENV_BASE_URL = http://dev.api/
├── .env.production     # ENV_APP_KEY = pro, ENV_BASE_URL = http://api/
└── .env.test          # ENV_APP_KEY = test, ENV_BASE_URL = http://test.api/
```

### Mode 参数传递

- `npm run dev` → Vite 默认补全为 `npm run dev -- --mode development`
- `npm run build` → Vite 默认补全为 `npm run build -- --mode production`
- 自定义模式：`npm run dev -- --mode test`

> **注意**：使用 npm 传递参数时需要双破折号 `--`，如 `npm run dev -- --mode dev`

## loadEnv 工作流程

当调用 `loadEnv` 时，会按以下步骤执行：

1. **读取基础配置**：直接找到 `.env` 文件并解析其中的环境变量，放进一个对象里
2. **读取模式配置**：将传入的 `mode` 变量值进行拼接（如 `.env.development`），根据提供的目录取对应配置文件并解析
3. **合并配置**：将两个配置对象合并，模式配置会覆盖基础配置中的同名变量

```js
// 伪代码示例
const baseEnvConfig = 读取.env的配置
const modeEnvConfig = 读取.env.[mode]的配置  
const lastEnvConfig = { ...baseEnvConfig, ...modeEnvConfig }
```

## 客户端环境变量访问

### import.meta.env

在客户端代码中，Vite 会将环境变量注入到 `import.meta.env` 对象中：

```js
// request.js 中的实际用法
console.log("import.meta.env=====", import.meta.env)
```

### 安全机制：VITE_ 前缀

Vite 做了安全拦截，防止隐私变量泄露到客户端：

- ✅ **允许**：以 `VITE_` 开头的环境变量会被注入到客户端
- ❌ **阻止**：其他环境变量不会注入到客户端（避免泄露敏感信息）

```bash
# ✅ 客户端可访问
VITE_API_URL = https://api.example.com

# ❌ 客户端无法访问  
DATABASE_PASSWORD = secret123
```

### 自定义前缀

可以通过 `envPrefix` 配置自定义前缀：

```js
// vite.config.js
export default defineConfig({
  envPrefix: 'APP_', // 现在以 APP_ 开头的变量会被注入
})
```

## 补充知识：ESModule 支持

Vite 配置文件支持 ESModule 语法的原理：

> Vite 在读取 `vite.config.js` 时会先用 Node.js 解析文件语法，如果发现是 ESModule 规范，会自动将其转换为 CommonJS 规范执行。

这就是为什么我们可以在配置文件中使用 `import` 和 `export default` 语法。

