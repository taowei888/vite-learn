# Vite 分包策略详解

分包（Code Splitting）是现代前端构建工具的重要优化手段，可以有效减少首屏加载时间，提升用户体验。

## 1. 什么是分包策略

分包策略是将应用代码按照一定规则拆分成多个独立的文件块（chunk），实现按需加载和缓存优化。

### 分包的优势

- **减少首屏加载时间**：只加载必需的代码
- **提高缓存效率**：第三方库和业务代码分离，提升缓存命中率
- **并行加载**：多个小文件可以并行下载
- **按需加载**：根据路由或功能模块动态加载

## 2. Vite 分包配置

### 基础配置

```typescript
import { defineConfig } from 'vite'
import path from 'path'

export default defineConfig({
  build: {
    rollupOptions: {
      // 多入口配置
      input: {
        main: path.resolve(__dirname, './index.html'),
        product: path.resolve(__dirname, './product.html')
      },
      output: {
        // 手动分包策略
        manualChunks: (id: string) => {
          // 将 node_modules 中的依赖打包到 vendor chunk
          if (id.includes('node_modules')) {
            return 'vendor'
          }
        }
      }
    }
  }
})
```

### 分包策略详解

#### 1. 基于依赖的分包

```typescript
manualChunks: (id: string) => {
  // 第三方库统一打包
  if (id.includes('node_modules')) {
    // 可以进一步细分大型库
    if (id.includes('lodash')) {
      return 'lodash'
    }
    if (id.includes('vue') || id.includes('react')) {
      return 'framework'
    }
    return 'vendor'
  }
}
```

#### 2. 基于功能模块的分包

```typescript
manualChunks: (id: string) => {
  if (id.includes('node_modules')) {
    return 'vendor'
  }
  
  // 按功能模块分包
  if (id.includes('/src/components/')) {
    return 'components'
  }
  if (id.includes('/src/utils/')) {
    return 'utils'
  }
  if (id.includes('/src/pages/')) {
    return 'pages'
  }
}
```

#### 3. 基于文件大小的分包

```typescript
manualChunks: (id: string) => {
  if (id.includes('node_modules')) {
    // 大型库单独分包
    if (id.includes('echarts') || id.includes('antd')) {
      return 'large-libs'
    }
    return 'vendor'
  }
}
```

## 3. 实际项目中的分包实践

### 多页面应用分包

在多页面应用中，每个页面可以作为独立的入口点：

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      input: {
        main: path.resolve(__dirname, './index.html'),
        product: path.resolve(__dirname, './product.html'),
        admin: path.resolve(__dirname, './admin.html')
      }
    }
  }
})
```

这样配置后，Vite 会：
- 为每个页面生成独立的 JS 文件
- 自动提取公共依赖到 vendor chunk
- 生成 modulepreload 链接优化加载性能

### 生成的文件结构示例

```
dist/
├── index.html
├── product.html
├── assets/
│   ├── main-[hash].js      # 主页面代码
│   ├── product-[hash].js   # 产品页面代码
│   ├── vendor-[hash].js    # 第三方依赖
│   └── modulepreload-polyfill-[hash].js
```

## 4. 性能优化建议

### 分包粒度控制

- **避免过度分包**：太多小文件会增加 HTTP 请求数量
- **合理设置阈值**：通常单个 chunk 控制在 100KB-500KB 之间
- **关注公共依赖**：确保公共代码能被有效复用

### 预加载策略

Vite 自动生成 `modulepreload` 链接，可以预加载关键资源：

```html
<link rel="modulepreload" crossorigin href="/assets/vendor-[hash].js">
```

### 缓存策略

- **vendor chunk**：第三方库，变更频率低，缓存时间长
- **main chunk**：业务代码，变更频率高，缓存时间相对较短
- **动态 import**：按需加载的模块，可设置中等缓存时间

## 5. 调试和分析

### 开发阶段调试

```typescript
output: {
  manualChunks: (id: string) => {
    console.log(id) // 输出模块 ID，便于调试
    if (id.includes('node_modules')) {
      return 'vendor'
    }
  }
}
```

### 构建分析

使用 `rollup-plugin-visualizer` 分析打包结果：

```bash
npm install --save-dev rollup-plugin-visualizer
```

```typescript
import { visualizer } from 'rollup-plugin-visualizer'

export default defineConfig({
  plugins: [
    visualizer({
      filename: 'dist/stats.html',
      open: true
    })
  ]
})
```

## 6. 最佳实践总结

1. **明确分包目标**：根据项目特点制定分包策略
2. **测试分包效果**：使用网络面板验证加载性能
3. **持续优化**：根据实际使用情况调整分包规则
4. **关注缓存**：确保分包策略有利于浏览器缓存
5. **监控性能**：定期分析首屏加载时间和资源大小

通过合理的分包策略，可以显著提升应用的加载性能和用户体验。