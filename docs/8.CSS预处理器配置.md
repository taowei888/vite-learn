# Vite CSS 预处理器配置详解

在 Vite 配置文件中，`css.preprocessorOptions` 主要用来配置 CSS 预处理器的全局参数，支持 Less、Sass/SCSS、Stylus 等预处理器。

## 完整配置示例

```javascript
// vite.base.config.js
export default defineConfig({
    css: {
        modules: {
            // CSS Modules 配置...
        },
        preprocessorOptions: { 
            // key + config: key代表预处理器名称
            less: { 
                // 整个配置对象最终会传给 Less 的执行参数（全局参数）
                math: 'always',
                globalVars: {
                    mainColor: 'red'
                },
                devSourceMap: true,
            }
        }
    }
})
```

## 预处理器安装

在没有构建工具的情况下，如果想要编译 Less 文件：

```bash
# 安装 Less 编译器
yarn add less
# 或
npm install less
```

**使用方式：**
- 安装了 Node.js → 可以使用 `node index.js`
- 安装了 Less → 可以使用 `lessc` 命令编译 Less 文件

## Less 配置选项详解

### 1. math 配置

**作用：** 控制 Less 中数学运算的执行方式

```javascript
math: 'always'
```

**可选值：**
- `'always'`：始终执行数学运算（如：`10px + 5px = 15px`）
- `'parens-division'`：只有在括号内或除法运算时才执行数学计算
- `'parens'`：只有在括号内才执行数学计算
- `'strict'`：严格模式，需要明确的数学运算符

**示例：**
```less
// 设置 math: 'always' 后
.container {
    width: 100px + 50px;  // 编译为：width: 150px;
    height: 200px / 2;    // 编译为：height: 100px;
}
```

### 2. globalVars 配置

**作用：** 定义在所有 Less 文件中都可以使用的全局变量

```javascript
globalVars: {
    mainColor: 'red'
}
```

**使用效果：**
```less
// 在任意 Less 文件中可以直接使用
.content {
    .main {
        background-color: @mainColor; // 使用全局变量，值为 'red'
    }
}
```

**优势：**
- 无需在每个文件中重复定义常用变量
- 便于主题管理和颜色统一
- 支持动态主题切换

### 3. devSourceMap 配置

**作用：** 在开发环境中生成 CSS 源码映射文件

```javascript
devSourceMap: true
```

**开启后的效果：**
- 浏览器开发者工具中可以看到样式来源于哪个 Less 文件的哪一行
- 便于调试，点击样式可以直接跳转到对应的 Less 源文件
- 提升开发体验，特别是在复杂的样式嵌套中

**注意：** 只在开发环境生效，不会影响生产构建

## 项目中的实际应用

### 文件结构
```
test-vite/
├── variables.less           # 变量定义文件
├── index.module.less        # Less 模块文件
└── vite.base.config.js     # Vite 配置文件
```

### 变量管理示例

**variables.less：**
```less
@color: red;
```

**index.module.less：**
```less
@import './variables.less';
.content {
    .main {
        background-color: @mainColor; // 使用全局变量
    }
}
```

**JavaScript 中使用：**
```javascript
import componentLess from "./index.module.less"
console.log('componentLess', componentLess)
```

## Source Map 详解

### 什么是 Source Map

Source Map 是文件之间的索引映射，解决代码被压缩或编译后难以调试的问题。

### 问题场景

假设我们的代码被压缩或编译过了，当程序出错时：
- **没有 Source Map**：错误位置信息指向编译后的代码，难以定位原始问题
- **有 Source Map**：通过索引文件（.map），可以准确定位到原始源码位置

### Source Map 的特点

- **解决的问题**：看似微小，但对开发调试极其重要
- **实现过程**：技术实现相对复杂，但对开发者透明
- **使用场景**：开发环境调试、生产环境错误追踪

### 配置建议

```javascript
preprocessorOptions: {
    less: {
        // 开发环境开启，便于调试
        devSourceMap: true,
        // 生产环境可以关闭，减少构建产物大小
        // devSourceMap: false
    }
}
```